---
- name: ğŸ“‹ ĞŸĞ¾ĞºĞ°Ğ·Ğ°Ñ‚ÑŒ Ğ²ÑĞµ A-Ğ·Ğ°Ğ¿Ğ¸ÑĞ¸ Ğ´Ğ¾Ğ¼ĞµĞ½Ğ°
  hosts: localhost
  gather_facts: no
  vars_files:
    - ./all.yml

  tasks:
    - name: ğŸ” ĞŸĞ¾Ğ»ÑƒÑ‡Ğ¸Ñ‚ÑŒ Ğ²ÑĞµ DNS-Ğ·Ğ°Ğ¿Ğ¸ÑĞ¸ Ğ¸Ğ· Porkbun
      uri:
        url: "https://api.porkbun.com/api/json/v3/dns/retrieve/{{ porkbun_domain }}"
        method: POST
        body:
          apikey: "{{ porkbun_api_key }}"
          secretapikey: "{{ porkbun_secret_api_key }}"
        body_format: json
        return_content: yes
      register: dns_response

    - name: âš ï¸ ĞŸÑ€Ğ¾Ğ²ĞµÑ€ĞºĞ°API Ğ²ĞµÑ€Ğ½ÑƒĞ» Ğ¾ÑˆĞ¸Ğ±ĞºÑƒ
      fail:
        msg: "âŒ ĞÑˆĞ¸Ğ±ĞºĞ° API Porkbun: {{ dns_response.json.status }} â€” {{ dns_response.json.message | default('Unknown error') }}"
      when: dns_response.json is defined and dns_response.json.status != "SUCCESS"

    - name: ğŸ§© Ğ˜Ğ·Ğ²Ğ»ĞµÑ‡ÑŒ Ğ¸ Ğ¾Ñ‚ÑĞ¾Ñ€Ñ‚Ğ¸Ñ€Ğ¾Ğ²Ğ°Ñ‚ÑŒ A-Ğ·Ğ°Ğ¿Ğ¸ÑĞ¸
      set_fact:
        a_records: >-
          {{
            dns_response.json.records
            | selectattr('type', 'equalto', 'A')
            | sort(attribute='name')
            | list
          }}

    - name: ğŸ“„ Ğ’Ñ‹Ğ²ĞµÑÑ‚Ğ¸ ÑĞ¿Ğ¸ÑĞ¾Ğº Ğ²ÑĞµÑ… A-Ğ·Ğ°Ğ¿Ğ¸ÑĞµĞ¹
      debug:
        msg: |-
          Ğ¡ĞŸĞ˜Ğ¡ĞĞš A-Ğ—ĞĞŸĞ˜Ğ¡Ğ•Ğ™ Ğ”Ğ›Ğ¯ {{ porkbun_domain }}

          {% for record in a_records %}
          {{ "%2d" % loop.index }}) {{ "%-30s" % record.name }} â†’ {{ record.content }}
          {% endfor %}
      when: a_records | length > 0

    - name: ğŸŸ¡ ĞĞµÑ‚ A-Ğ·Ğ°Ğ¿Ğ¸ÑĞµĞ¹
      debug:
        msg: |-
          ğŸ“­ ĞĞ•Ğ¢ A-Ğ—ĞĞŸĞ˜Ğ¡Ğ•Ğ™ Ğ´Ğ»Ñ Ğ´Ğ¾Ğ¼ĞµĞ½Ğ°: {{ porkbun_domain }}
      when: a_records | length == 0
