---
- name: ‚ùå –£–¥–∞–ª–∏—Ç—å A-–∑–∞–ø–∏—Å—å –ø–æ —Å—É–±–¥–æ–º–µ–Ω—É –∏ IP
  hosts: localhost
  gather_facts: no

  tasks:
    - name: üîç –ü–æ–ª—É—á–∏—Ç—å –≤—Å–µ DNS-–∑–∞–ø–∏—Å–∏ –∏–∑ Porkbun
      uri:
        url: "https://api.porkbun.com/api/json/v3/dns/retrieve/{{ porkbun_domain }}"
        method: POST
        body:
          apikey: "{{ porkbun_api_key }}"
          secretapikey: "{{ porkbun_secret_api_key }}"
        body_format: json
        return_content: yes
      register: dns_response

    - name: ‚ùå –ü—Ä–µ—Ä–≤–∞—Ç—å –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ –ø—Ä–∏ –æ—à–∏–±–∫–µ API
      fail:
        msg: "–û—à–∏–±–∫–∞ API Porkbun {{ dns_response.json.status }} ‚Äî {{ dns_response.json.message | default('Unknown error') }}"
      when: dns_response.json is defined and dns_response.json.status != "SUCCESS"

    - name: üß© –ò–∑–≤–ª–µ—á—å –∏ –æ—Ç—Å–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å A-–∑–∞–ø–∏—Å–∏
      set_fact:
        a_records: >-
          {{
            dns_response.json.records
            | selectattr('type', 'equalto', 'A')
            | sort(attribute='name')
            | list
          }}

    - name: üìÑ –í—ã–≤–µ—Å—Ç–∏ —Å–ø–∏—Å–æ–∫ –≤—Å–µ—Ö A-–∑–∞–ø–∏—Å–µ–π
      debug:
        msg: |-
          –°–ü–ò–°–û–ö A-–ó–ê–ü–ò–°–ï–ô –î–õ–Ø {{ porkbun_domain }}

          {% for record in a_records %}
          {{ "%2d" % loop.index }}) {{ "%-30s" % record.name }} ‚Üí {{ record.content }}
          {% endfor %}
      when: a_records | length > 0

    - name: üü° –ù–µ—Ç A-–∑–∞–ø–∏—Å–µ–π –¥–ª—è –¥–æ–º–µ–Ω–∞
      debug:
        msg: |-
           –ù–ï–¢ A-–ó–ê–ü–ò–°–ï–ô –¥–ª—è –¥–æ–º–µ–Ω–∞ {{ porkbun_domain }}
      when: a_records | length == 0

    - name: üß© –ó–∞–ø—Ä–æ—Å–∏—Ç—å IP-–∞–¥—Ä–µ—Å
      pause:
        prompt: "–í–≤–µ–¥–∏—Ç–µ IP-–∞–¥—Ä–µ—Å (–Ω–∞–ø—Ä–∏–º–µ—Ä, 1.1.1.1)"
      register: target_ip_input

    - name: üß© –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –≤–≤–µ–¥—ë–Ω–Ω—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è
      set_fact:
        target_ip: "{{ target_ip_input.user_input }}"

    - name: üß© –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –≤–≤–µ–¥—ë–Ω–Ω—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è
      set_fact:
        subdomain: ""

    - name:  üìÑ –í—ã–≤–µ—Å—Ç–∏ –≤–≤–µ–¥–µ–Ω–Ω—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è
      debug:
        msg: |-
           –î–æ–º–µ–Ω  ‚Üí {{porkbun_domain}}
           IP  ‚Üí {{target_ip}}

    - name: üß© –ù–∞–π—Ç–∏ A-–∑–∞–ø–∏—Å—å —Å –∏–º–µ–Ω–µ–º {{ subdomain }} –∏ IP {{ target_ip }}
      set_fact:
        target_record: "{{ item }}"
      loop: "{{ dns_response.json.records }}"
      when: >
        item.type == 'A' and
        item.name == porkbun_domain and
        item.content == target_ip | trim

    - name: üö´ –ù–µ—Ç —Å–æ–≤–ø–∞–¥–∞—é—â–µ–π A-–∑–∞–ø–∏—Å–∏
      debug:
        msg: "‚ùå –ù–µ –Ω–∞–π–¥–µ–Ω–æ A-–∑–∞–ø–∏—Å–∏ {{ porkbun_domain }} ‚Üí {{ target_ip }}"
      when: target_record is not defined

    - name: üõë –ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç–µ —É–¥–∞–ª–µ–Ω–∏–µ –∑–∞–ø–∏—Å–∏
      pause:
        prompt: "–í–≤–µ–¥–∏—Ç–µ 'yes' –¥–ª—è –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è, –∏–ª–∏ –Ω–∞–∂–º–∏—Ç–µ Ctrl+C –¥–ª—è –æ—Ç–º–µ–Ω—ã"
      register: confirmation_pause
      when: target_record is defined

    - name: üóëÔ∏è –£–¥–∞–ª–∏—Ç—å A-–∑–∞–ø–∏—Å—å —á–µ—Ä–µ–∑ API
      uri:
        url: "https://api.porkbun.com/api/json/v3/dns/delete/{{ porkbun_domain }}/{{ target_record.id }}"
        method: POST
        body:
          apikey: "{{ porkbun_api_key }}"
          secretapikey: "{{ porkbun_secret_api_key }}"
        body_format: json
        status_code: 200
      register: delete_result
      when: target_record is defined

    - name: ‚úÖ –û—Ç—á—ë—Ç –æ–± —É–¥–∞–ª–µ–Ω–∏–∏
      debug:
        msg: >-
          {% if delete_result is succeeded %}
          ‚úÖ –£—Å–ø–µ—à–Ω–æ —É–¥–∞–ª–µ–Ω–∞ {{ subdomain }}.{{ porkbun_domain }} ‚Üí {{ target_ip }}
          {% else %}
          ‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ {{ delete_result.status }} {{ delete_result.status_text }}
          {% endif %}
      when: target_record is defined
