- name: üß™ –ü—Ä–æ–≤–µ—Ä–∫–∞ –≤—Ö–æ–¥–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö
  debug:
    msg: |
      –¶–µ–ª—å: {{ subdomain }}.{{ porkbun_domain }}
      –£–¥–∞–ª–∏—Ç—å: ‚Üí {{ old_ip }}
      –°–æ–∑–¥–∞—Ç—å: ‚Üí {{ new_ip }}

- name: üîç –ü–æ–ª—É—á–∏—Ç—å –≤—Å–µ DNS-–∑–∞–ø–∏—Å–∏ –∏–∑ Porkbun
  uri:
    url: "https://api.porkbun.com/api/json/v3/dns/retrieve/{{ porkbun_domain }}"
    method: POST
    body:
      apikey: "{{ porkbun_api_key }}"
      secretapikey: "{{ porkbun_secret_api_key }}"
    body_format: json
    return_content: yes
  register: dns_response

#- name: ‚ö†Ô∏è –ü—Ä–æ–≤–µ—Ä–∫–∞: API –≤–µ—Ä–Ω—É–ª –æ—à–∏–±–∫—É
#  fail:
#    msg: "‚ùå –û—à–∏–±–∫–∞ API {{ dns_response.json.status }} -- {{ dns_response.json.message | default('Unknown error') }}"
#  when: dns_response.json is defined and dns_response.json.status != "SUCCESS"

- name: üß© –ù–∞–π—Ç–∏ A-–∑–∞–ø–∏—Å—å {{ subdomain }} ‚Üí {{ old_ip }}
  set_fact:
    record_to_delete: "{{ item }}"
  loop: "{{ dns_response.json.records }}"
  when: >
    item.type == 'A' and
    item.name == (subdomain + '.' + porkbun_domain) and
    item.content == old_ip | trim

- name: üóë –£–¥–∞–ª–∏—Ç—å —Å—Ç–∞—Ä—É—é A-–∑–∞–ø–∏—Å—å {{ subdomain }} ‚Üí {{ old_ip }}
  uri:
    url: "https://api.porkbun.com/api/json/v3/dns/delete/{{ porkbun_domain }}/{{ record_to_delete.id }}"
    method: POST
    body:
      apikey: "{{ porkbun_api_key }}"
      secretapikey: "{{ porkbun_secret_api_key }}"
    body_format: json
    status_code: 200
  register: delete_result
  when: record_to_delete is defined

- name: ‚úÖ –£—Å–ø–µ—à–Ω–æ —É–¥–∞–ª–µ–Ω–∞ —Å—Ç–∞—Ä–∞—è –∑–∞–ø–∏—Å—å
  debug:
    msg: "‚úÖ –£–¥–∞–ª–µ–Ω–æ: {{ subdomain }}.{{ porkbun_domain }} ‚Üí {{ old_ip }}"
  when: record_to_delete is defined and delete_result is succeeded

- name: ‚ùå –ù–µ –Ω–∞–π–¥–µ–Ω–∞ –∑–∞–ø–∏—Å—å –¥–ª—è —É–¥–∞–ª–µ–Ω–∏—è
  debug:
    msg: "üü° –ù–µ –Ω–∞–π–¥–µ–Ω–∞ A-–∑–∞–ø–∏—Å—å {{ subdomain }}.{{ porkbun_domain }} ‚Üí {{ old_ip }}"
  when: record_to_delete is not defined

- name: ‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏
  debug:
    msg: "‚ùå –û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è {{ delete_result.status }} {{ delete_result.status_text }}"
  when: record_to_delete is defined and delete_result is failed

- name: üöÄ –°–æ–∑–¥–∞—Ç—å –Ω–æ–≤—É—é A-–∑–∞–ø–∏—Å—å {{ subdomain }} ‚Üí {{ new_ip }}
  uri:
    url: "https://api.porkbun.com/api/json/v3/dns/create/{{ porkbun_domain }}"
    method: POST
    body:
      apikey: "{{ porkbun_api_key }}"
      secretapikey: "{{ porkbun_secret_api_key }}"
      name: "{{ subdomain }}"
      type: "A"
      content: "{{ new_ip }}"
      ttl: "300"
    body_format: json
    status_code: 200
  register: create_result

- name: ‚úÖ –£—Å–ø–µ—à–Ω–æ —Å–æ–∑–¥–∞–Ω–∞ –Ω–æ–≤–∞—è –∑–∞–ø–∏—Å—å
  debug:
    msg: "‚úÖ –°–æ–∑–¥–∞–Ω–æ: {{ subdomain }}.{{ porkbun_domain }} ‚Üí {{ new_ip }}"
  when: create_result is succeeded

- name: ‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏
  debug:
    msg: |-
      ‚ùå –û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è {{ create_result.json.message | default('HTTP ' + create_result.status|string) }}
      –í–æ–∑–º–æ–∂–Ω—ã–µ –ø—Ä–∏—á–∏–Ω—ã
      ‚Ä¢ –£–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç A-–∑–∞–ø–∏—Å—å —Å —Ç–∞–∫–∏–º –∏–º–µ–Ω–µ–º
      ‚Ä¢ –û—à–∏–±–∫–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏
      ‚Ä¢ –ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π IP
  when: create_result is failed
