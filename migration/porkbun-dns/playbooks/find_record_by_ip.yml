# playbooks/find_record_by_ip.yml
---
- name: ğŸ” ĞĞ°Ğ¹Ñ‚Ğ¸ ÑÑƒĞ±Ğ´Ğ¾Ğ¼ĞµĞ½(Ñ‹) Ğ¿Ğ¾ IP-Ğ°Ğ´Ñ€ĞµÑÑƒ
  hosts: localhost
  gather_facts: no
  vars_files:
      - /etc/ansible/migration/inventory/porkbun.yml

  vars_prompt:
      - name: target_ip
        prompt: "Ğ’Ğ²ĞµĞ´Ğ¸Ñ‚Ğµ IP-Ğ°Ğ´Ñ€ĞµÑ Ğ´Ğ»Ñ Ğ¿Ğ¾Ğ¸ÑĞºĞ°"
        private: no

  tasks:
      - name: ğŸ” ĞŸĞ¾Ğ»ÑƒÑ‡Ğ¸Ñ‚ÑŒ Ğ²ÑĞµ DNS-Ğ·Ğ°Ğ¿Ğ¸ÑĞ¸ Ğ¸Ğ· Porkbun
        uri:
            url: "https://api.porkbun.com/api/json/v3/dns/retrieve/{{ porkbun_domain }}"
            method: POST
            body:
                apikey: "{{ porkbun_api_key }}"
                secretapikey: "{{ porkbun_secret_api_key }}"
            body_format: json
            return_content: yes
        register: dns_response

      - name: âš ï¸ ĞŸÑ€Ğ¾Ğ²ĞµÑ€ĞºĞ°API Ğ²ĞµÑ€Ğ½ÑƒĞ» Ğ¾ÑˆĞ¸Ğ±ĞºÑƒ
        fail:
            msg: "âŒ ĞÑˆĞ¸Ğ±ĞºĞ° API Porkbun {{ dns_response.json.status }} â€” {{ dns_response.json.message | default('Unknown error') }}"
        when: dns_response.json is defined and dns_response.json.status != "SUCCESS"

      - name: ğŸ§© ĞĞ°Ğ¹Ñ‚Ğ¸ ÑƒĞ½Ğ¸ĞºĞ°Ğ»ÑŒĞ½Ñ‹Ğµ Ğ¸Ğ¼ĞµĞ½Ğ° A-Ğ·Ğ°Ğ¿Ğ¸ÑĞµĞ¹ Ñ IP {{ target_ip }}
        set_fact:
            target_names: >-
                {{
                  dns_response.json.records
                  | selectattr('type', 'equalto', 'A')
                  | selectattr('content', 'equalto', target_ip | trim)
                  | map(attribute='name')
                  | unique
                  | sort
                  | list
                }}

      - name: ğŸ“„ Ğ’Ñ‹Ğ²ĞµÑÑ‚Ğ¸ Ğ½Ğ°Ğ¹Ğ´ĞµĞ½Ğ½Ñ‹Ğµ ÑÑƒĞ±Ğ´Ğ¾Ğ¼ĞµĞ½Ñ‹
        debug:
            msg: |-
                ĞŸĞĞ˜Ğ¡Ğš ĞŸĞ IP {{ target_ip }}
                ĞĞ°Ğ¹Ğ´ĞµĞ½Ğ¾ {{ target_names | length }} ÑÑƒĞ±Ğ´Ğ¾Ğ¼ĞµĞ½(Ğ¾Ğ²)
                {% for name in target_names %}
                {{ "%2d" % (loop.index) }}) {{ name }}
                {% endfor %}
        when: target_names | length > 0

      - name: ğŸŸ¡ Ğ¡ÑƒĞ±Ğ´Ğ¾Ğ¼ĞµĞ½Ñ‹ Ñ IP {{ target_ip }} Ğ½Ğµ Ğ½Ğ°Ğ¹Ğ´ĞµĞ½Ñ‹
        debug:
            msg: |-
                ĞĞ•Ğ¢ A-Ğ—ĞĞŸĞ˜Ğ¡Ğ•Ğ™ Ñ IP {{ target_ip }}
        when: target_names | length == 0

      - name: ğŸ” ĞŸĞ¾ĞºĞ°Ğ·Ğ°Ñ‚ÑŒ Ğ’Ğ¡Ğ• DNS-Ğ·Ğ°Ğ¿Ğ¸ÑĞ¸ Ğ´Ğ»Ñ Ğ½Ğ°Ğ¹Ğ´ĞµĞ½Ğ½Ñ‹Ñ… ÑÑƒĞ±Ğ´Ğ¾Ğ¼ĞµĞ½Ğ¾Ğ²
        debug:
            msg: |-
                Ğ’Ğ¡Ğ• Ğ—ĞĞŸĞ˜Ğ¡Ğ˜ Ğ”Ğ›Ğ¯ {{ item }}

                {% set all_records_for_name = dns_response.json.records
                  | selectattr('name', 'equalto', item)
                  | sort(attribute='type')
                  | list %}
                {% if all_records_for_name | length > 0 %}
                {% for r in all_records_for_name %}
                â€¢ {{ "%-8s" % r.type }} â†’ {{ r.content }} (TTL {{ r.ttl }})
                {% endfor %}
                {% else %}
                â€¢ ĞĞµÑ‚ DNS-Ğ·Ğ°Ğ¿Ğ¸ÑĞµĞ¹
                {% endif %}
        loop: "{{ target_names }}"
        when: target_names | length > 0
        loop_control:
            label: "ğŸ” {{ item }}"
