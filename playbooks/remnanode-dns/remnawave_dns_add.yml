# ============================================================================
# –í–ê–ñ–ù–û: –≠—Ç–æ—Ç –ø–ª–µ–π–±—É–∫ –¢–û–õ–¨–ö–û –°–û–ó–î–ê–ï–¢ DNS –∑–∞–ø–∏—Å–∏, –ù–ò –í –ö–û–ï–ú –°–õ–£–ß–ê–ï –ù–ï –£–î–ê–õ–Ø–ï–¢!
# –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ API endpoint /dns/create/ –¥–ª—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è A-–∑–∞–ø–∏—Å–µ–π.
# –°—É—â–µ—Å—Ç–≤—É—é—â–∏–µ –∑–∞–ø–∏—Å–∏ –æ—Å—Ç–∞—é—Ç—Å—è –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π.
# ============================================================================

# --- –®–ê–ì 0: –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã—Ö –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö ---
- name: ‚úÖ –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –Ω–∞–ª–∏—á–∏–µ porkbun_api_key
  fail:
      msg: "–ü–µ—Ä–µ–º–µ–Ω–Ω–∞—è 'porkbun_api_key' –Ω–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∞!"
  when: porkbun_api_key is not defined or porkbun_api_key == ""
  run_once: true
  delegate_to: localhost

- name: ‚úÖ –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –Ω–∞–ª–∏—á–∏–µ porkbun_secret_api_key
  fail:
      msg: "–ü–µ—Ä–µ–º–µ–Ω–Ω–∞—è 'porkbun_secret_api_key' –Ω–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∞!"
  when: porkbun_secret_api_key is not defined or porkbun_secret_api_key == ""
  run_once: true
  delegate_to: localhost

- name: ‚úÖ –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —á—Ç–æ domains_to_process –Ω–µ –ø—É—Å—Ç
  fail:
      msg: "–ü–µ—Ä–µ–º–µ–Ω–Ω–∞—è 'domains_to_process' –ø—É—Å—Ç–∞ –∏–ª–∏ –Ω–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∞! –£–∫–∞–∂–∏—Ç–µ —Ö–æ—Ç—è –±—ã –æ–¥–∏–Ω –¥–æ–º–µ–Ω."
  when: domains_to_process | default([]) | length == 0
  run_once: true
  delegate_to: localhost

# --- –®–ê–ì 1: –°–æ–±—Ä–∞—Ç—å IP –∞–¥—Ä–µ—Å–∞ –∏–∑ inventory –¥–ª—è —Å–µ—Ä–≤–µ—Ä–æ–≤ —Å–æ —Å—Ç–∞—Ç—É—Å–æ–º "new" ---
- name: üß© –°–æ–±—Ä–∞—Ç—å IP –∞–¥—Ä–µ—Å–∞ —Å–µ—Ä–≤–µ—Ä–æ–≤ —Å–æ —Å—Ç–∞—Ç—É—Å–æ–º "new"
  set_fact:
      new_servers_ips: "{{ new_servers_ips | default([]) + [hostvars[item].ansible_host] }}"
  loop: "{{ groups['servers'] | default([]) }}"
  when:
      - hostvars[item].status | default('') == 'new'
      - hostvars[item].ansible_host is defined
  run_once: true
  delegate_to: localhost

- name: üß© –£–±—Ä–∞—Ç—å –¥—É–±–ª–∏–∫–∞—Ç—ã IP –∞–¥—Ä–µ—Å–æ–≤
  set_fact:
      new_servers_ips: "{{ new_servers_ips | default([]) | unique | list }}"
  run_once: true
  delegate_to: localhost

- name: üìÑ –í—ã–≤–µ—Å—Ç–∏ —Å–ø–∏—Å–æ–∫ —Å–µ—Ä–≤–µ—Ä–æ–≤ –∏–∑ inventory –¥–ª—è DNS
  debug:
      msg: |-
          –°–ï–†–í–ï–†–´ –ò–ó INVENTORY ({{ new_servers_ips | length }} —à—Ç.):
          {% for ip in new_servers_ips %}
          {{ "%2d" % loop.index }}) {{ ip }}
          {% endfor %}
  run_once: true
  delegate_to: localhost
  when: new_servers_ips | length > 0

- name: üü° –ù–µ—Ç —Å–µ—Ä–≤–µ—Ä–æ–≤ —Å–æ —Å—Ç–∞—Ç—É—Å–æ–º "new" ‚Äî –ø—Ä–æ–ø—É—Å–∫–∞–µ–º DNS-–æ–ø–µ—Ä–∞—Ü–∏–∏
  debug:
      msg: "–ù–µ—Ç —Å–µ—Ä–≤–µ—Ä–æ–≤ —Å–æ —Å—Ç–∞—Ç—É—Å–æ–º 'new' –≤ inventory. –ù–∏—á–µ–≥–æ –¥–µ–ª–∞—Ç—å –Ω–µ –Ω—É–∂–Ω–æ."
  run_once: true
  delegate_to: localhost
  when: new_servers_ips | length == 0

# --- –®–ê–ì 2: –î–ª—è –∫–∞–∂–¥–æ–≥–æ –¥–æ–º–µ–Ω–∞ –ø–æ–ª—É—á–∏—Ç—å –≤—Å–µ DNS-–∑–∞–ø–∏—Å–∏ ---
- name: üîç –ü–æ–ª—É—á–∏—Ç—å –≤—Å–µ DNS-–∑–∞–ø–∏—Å–∏ –¥–ª—è –¥–æ–º–µ–Ω–∞
  uri:
      url: "https://api.porkbun.com/api/json/v3/dns/retrieve/{{ item }}"
      method: POST
      body:
          apikey: "{{ porkbun_api_key }}"
          secretapikey: "{{ porkbun_secret_api_key }}"
      body_format: json
      return_content: yes
  register: dns_retrieve_results
  ignore_errors: yes
  loop: "{{ domains_to_process }}"
  loop_control:
      label: "{{ item }}"
  run_once: true
  delegate_to: localhost

# --- –î–ï–ë–ê–ì: –í—ã–≤–µ—Å—Ç–∏ —Å—ã—Ä—ã–µ DNS-–∑–∞–ø–∏—Å–∏ –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏ ---
- name: üêû DEBUG ‚Äî –°—ã—Ä—ã–µ DNS-–∑–∞–ø–∏—Å–∏ –¥–ª—è –¥–æ–º–µ–Ω–∞
  debug:
      var: result.json.records
  loop: "{{ domains_to_process }}"
  loop_control:
      label: "{{ item }}"
  vars:
      result: "{{ dns_retrieve_results.results | selectattr('item', 'equalto', item) | first }}"
  when: result.json is defined and result.json.status == "SUCCESS"
  run_once: true
  delegate_to: localhost

# --- –®–ê–ì 3: –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –æ—à–∏–±–∫–∏ Porkbun API ---
- name: ‚ùå –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –æ—à–∏–±–∫—É Porkbun API –¥–ª—è –¥–æ–º–µ–Ω–∞
  fail:
      msg: "Porkbun API error for {{ item }}: {{ result.json.message | default('Unknown') }}"
  when: result.json is defined and result.json.status != "SUCCESS"
  loop: "{{ domains_to_process }}"
  loop_control:
      label: "{{ item }}"
  vars:
      result: "{{ dns_retrieve_results.results | selectattr('item', 'equalto', item) | first }}"
  run_once: true
  delegate_to: localhost

- name: üß© –ü–æ—Å—Ç—Ä–æ–∏—Ç—å existing_ips_map (—Ç–æ–ª—å–∫–æ A-–∑–∞–ø–∏—Å–∏ –¥–ª—è apex-–¥–æ–º–µ–Ω–∞)
  set_fact:
      existing_ips_map: >-
          {{
            existing_ips_map | default({}) | combine({
              item: (
                (
                  (dns_retrieve_results.results | selectattr('item', 'equalto', item) | first | default({}))
                  .json.records | default([])
                )
                | selectattr('type', 'equalto', 'A')
                | selectattr('name', 'equalto', item)
                | map(attribute='content')
                | map('trim')
                | list
                | unique
              )
            })
          }}
  loop: "{{ domains_to_process }}"
  loop_control:
      label: "{{ item }}"
  run_once: true
  delegate_to: localhost
  delegate_facts: true

# --- –î–ï–ë–ê–ì: –í—ã–≤–µ—Å—Ç–∏ existing_ips_map ---
- name: üêû DEBUG ‚Äî existing_ips_map (—Ç–µ–∫—É—â–∏–µ IP –ø–æ –¥–æ–º–µ–Ω–∞–º)
  debug:
      var: existing_ips_map
  run_once: true
  delegate_to: localhost

- name: üöÄ –°–æ–∑–¥–∞—Ç—å –æ—Ç—Å—É—Ç—Å—Ç–≤—É—é—â–∏–µ A-–∑–∞–ø–∏—Å–∏ (–¥–ª—è apex-–¥–æ–º–µ–Ω–∞)
  uri:
      url: "https://api.porkbun.com/api/json/v3/dns/create/{{ domain }}"
      method: POST
      body:
          apikey: "{{ porkbun_api_key }}"
          secretapikey: "{{ porkbun_secret_api_key }}"
          name: ""
          type: "A"
          content: "{{ server_ip }}"
          ttl: "300"
      body_format: json
      status_code: [200, 400]
  loop: "{{ new_servers_ips | product(domains_to_process) | list }}"
  loop_control:
      loop_var: pair
      label: "{{ pair.1 }} ‚Üí {{ pair.0 }}"
  vars:
      server_ip: "{{ pair.0 }}"
      domain: "{{ pair.1 }}"
      existing_ips: "{{ existing_ips_map[domain] | default([]) | map('trim') | list }}"
      inventory_ip: "{{ server_ip | trim }}"
  when:
      - new_servers_ips | length > 0
      - inventory_ip not in existing_ips
  register: create_results
  failed_when: false
  changed_when: create_results.status == 200
  run_once: true
  delegate_to: localhost

# --- –î–ï–ë–ê–ì: –°—Ä–∞–≤–Ω–µ–Ω–∏–µ IP –ø–æ –¥–æ–º–µ–Ω–∞–º ---
- name: üêû DEBUG ‚Äî –°—Ä–∞–≤–Ω–µ–Ω–∏–µ IP –ø–æ –¥–æ–º–µ–Ω—É
  debug:
      msg: |-
          –î–æ–º–µ–Ω: {{ domain }}
          IP –∏–∑ inventory: {{ inventory_ips }}
          –°—É—â–µ—Å—Ç–≤—É—é—â–∏–µ IP: {{ existing_ips }}
          –û—Ç—Å—É—Ç—Å—Ç–≤—É—é—â–∏–µ IP: {{ missing_ips }}
  loop: "{{ domains_to_process }}"
  loop_control:
      label: "{{ domain }}"
  vars:
      domain: "{{ item }}"
      existing_ips: "{{ existing_ips_map[item] | default([]) | map('trim') | list }}"
      inventory_ips: "{{ new_servers_ips | default([]) | map('trim') | list | unique }}"
      missing_ips: "{{ inventory_ips | difference(existing_ips) }}"
  run_once: true
  delegate_to: localhost

# --- –£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ: —Å–∫–æ–ª—å–∫–æ –∑–∞–ø–∏—Å–µ–π —Å–æ–∑–¥–∞–Ω–æ –ø–æ –∫–∞–∂–¥–æ–º—É –¥–æ–º–µ–Ω—É ---
- name: ‚úÖ –£—Å–ø–µ—à–Ω–æ —Å–æ–∑–¥–∞–Ω—ã –∑–∞–ø–∏—Å–∏ ‚Äî —Å–≤–æ–¥–∫–∞ –ø–æ –¥–æ–º–µ–Ω–∞–º
  debug:
      msg: "‚úÖ –í –¥–æ–º–µ–Ω–µ {{ domain }} —Å–æ–∑–¥–∞–Ω–æ A-–∑–∞–ø–∏—Å–µ–π: {{ count }}"
  loop: "{{ domains_to_process }}"
  loop_control:
      label: "{{ domain }}"
  vars:
      domain: "{{ item }}"
      count: >-
          {% set records = create_results.results | default([]) %}
          {% set total = 0 %}
          {% for rec in records %}
            {% if rec.changed is defined and rec.changed and rec.item is defined and rec.item | length >= 2 and rec.item[1] == domain %}
              {% set total = total + 1 %}
            {% endif %}
          {% endfor %}
          {{ total }}
  run_once: true
  delegate_to: localhost

# --- –£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ: –µ—Å–ª–∏ —Å–æ–∑–¥–∞–≤–∞—Ç—å –Ω–µ—á–µ–≥–æ ---
- name: ‚ÑπÔ∏è –ó–∞–ø–∏—Å–∏ –Ω–µ —Ç—Ä–µ–±—É—é—Ç—Å—è ‚Äî –≤—Å–µ IP —É–∂–µ –µ—Å—Ç—å
  debug:
      msg: "‚ÑπÔ∏è –í—Å–µ —Å–µ—Ä–≤–µ—Ä—ã –∏–∑ inventory —É–∂–µ –∏–º–µ—é—Ç A-–∑–∞–ø–∏—Å–∏ –≤ –¥–æ–º–µ–Ω–µ {{ domain }}"
  loop: "{{ domains_to_process }}"
  loop_control:
      label: "{{ domain }}"
  vars:
      domain: "{{ item }}"
      existing_ips: "{{ existing_ips_map[item] | default([]) | map('trim') | list }}"
      inventory_ips: "{{ new_servers_ips | default([]) | map('trim') | list | unique }}"
      missing: "{{ inventory_ips | difference(existing_ips) }}"
  when: missing | length == 0
  run_once: true
  delegate_to: localhost

# --- –§–ò–ù–ê–õ: –ò—Ç–æ–≥–æ–≤–∞—è —Å–≤–æ–¥–∫–∞ ---
- name: üìä –ò—Ç–æ–≥–æ–≤–∞—è —Å–≤–æ–¥–∫–∞
  debug:
      msg: |-

          –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è DNS –∑–∞–≤–µ—Ä—à–µ–Ω–∞.

          –°–µ—Ä–≤–µ—Ä–æ–≤ –∏–∑ inventory {{ new_servers_ips | length }}

          –¶–µ–ª–µ–≤—ã—Ö –¥–æ–º–µ–Ω–æ–≤ {{ domains_to_process | length }}

  when: new_servers_ips | length > 0
  run_once: true
  delegate_to: localhost

- name: üìä –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è –Ω–µ —Ç—Ä–µ–±–æ–≤–∞–ª–∞—Å—å ‚Äî —Å–µ—Ä–≤–µ—Ä–æ–≤ –Ω–µ—Ç
  debug:
      msg: "‚ÑπÔ∏è –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è –Ω–µ –ø—Ä–æ–≤–æ–¥–∏–ª–∞—Å—å ‚Äî —Å–µ—Ä–≤–µ—Ä–æ–≤ —Å–æ —Å—Ç–∞—Ç—É—Å–æ–º 'new' –Ω–µ –æ–±–Ω–∞—Ä—É–∂–µ–Ω–æ."
  when: new_servers_ips | length == 0
  run_once: true
  delegate_to: localhost
