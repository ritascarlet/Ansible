- name: Установка и запуск remnanode через Docker Compose
  hosts: servers
  become: yes
  vars:
    remnanode_dir: /opt/remnanode
    app_port: 2222
    ssl_cert: "{{ vault_remnanode_ssl_cert | default('SSL_CERT=CHANGE_ME') }}"
  tasks:
    - name: Установить Docker
      shell: curl -fsSL https://get.docker.com | sh
      args:
        creates: /usr/bin/docker

    - name: Создать каталог проекта
      file:
        path: "{{ remnanode_dir }}"
        state: directory
        mode: "0755"

    - name: Создать .env для remnanode
      copy:
        dest: "{{ remnanode_dir }}/.env"
        content: |
          APP_PORT={{ app_port }}
          {{ ssl_cert }}

    - name: Создать docker-compose.yml
      copy:
        dest: "{{ remnanode_dir }}/docker-compose.yml"
        content: |
          services:
            remnanode:
              container_name: remnanode
              hostname: remnanode
              image: remnawave/node:latest
              restart: always
              network_mode: host
              env_file:
                - .env

    - name: Запустить контейнер remnanode через Docker Compose
      shell: |
        docker compose up -d
      args:
        chdir: "{{ remnanode_dir }}"

    - name: Показать логи контейнера remnanode
      shell: |
        docker compose logs -f -t
      args:
        chdir: "{{ remnanode_dir }}"
      async: 60
      poll: 0

- import_playbook: create_remnanode.yml
#- import_playbook: playbooks/prepare_system.yml
#- import_playbook: playbooks/create_user.yml
#- import_playbook: playbooks/install_fail2ban.yml
#- import_playbook: playbooks/configure_ssh.yml
