---
- name: Deploy Caddy with two websites
  hosts: servers
  become: yes
  vars:
    base_dir: "./"
    working_dir: "/opt/caddy"

  tasks:
    # 1) ĞŸÑ€Ğ¾Ğ²ĞµÑ€ĞºĞ° ÑƒÑÑ‚Ğ°Ğ½Ğ¾Ğ²ĞºĞ¸ Docker
    - name: Check if Docker is installed
      command: docker --version
      register: docker_check
      ignore_errors: yes
      changed_when: false

    - name: Fail if Docker is not installed
      fail:
        msg: "Docker is not installed. Please install Docker first."
      when: docker_check.rc != 0

    # 2) Ğ¡Ğ¾Ğ·Ğ´Ğ°Ğ½Ğ¸Ğµ Ñ€Ğ°Ğ±Ğ¾Ñ‡Ğ¸Ñ… Ğ´Ğ¸Ñ€ĞµĞºÑ‚Ğ¾Ñ€Ğ¸Ğ¹ Ğ½Ğ° ÑƒĞ´Ğ°Ğ»ĞµĞ½Ğ½Ğ¾Ğ¼ ÑĞµÑ€Ğ²ĞµÑ€Ğµ
    - name: Create working directories on server
      file:
        path: "{{ item }}"
        state: directory
        mode: "0755"
      loop:
        - "{{ working_dir }}"
        - "{{ working_dir }}/data"
        - "{{ working_dir }}/logs"
        - "/var/www/domain.com"
        - "/var/www/domain.com"

    # 3) ĞšĞ¾Ğ¿Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğµ Caddyfile Ğ¸Ğ· Ğ»Ğ¾ĞºĞ°Ğ»ÑŒĞ½Ğ¾Ğ¹ Ğ¿Ğ°Ğ¿ĞºĞ¸ caddy/
    - name: Copy Caddyfile
      copy:
        src: "{{ base_dir }}/caddy/Caddyfile"
        dest: "{{ working_dir }}/Caddyfile"
        mode: "0644"

    # 4) ĞšĞ¾Ğ¿Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğµ Ñ„Ğ°Ğ¹Ğ»Ğ¾Ğ² ÑĞ°Ğ¹Ñ‚Ğ¾Ğ² Ğ¸Ğ· Ğ»Ğ¾ĞºĞ°Ğ»ÑŒĞ½Ñ‹Ñ… Ğ¿Ğ°Ğ¿Ğ¾Ğº
    - name: Copy domain.com website files
      copy:
        src: "{{ base_dir }}/domain.com/"
        dest: "/var/www/domain.com/"
        mode: "0644"
        directory_mode: "0755"

    - name: Copy domain.com website files
      copy:
        src: "{{ base_dir }}/domain.com/"
        dest: "/var/www/domain.com/"
        mode: "0644"
        directory_mode: "0755"

    # 5) ĞšĞ¾Ğ¿Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğµ docker-compose.yml Ğ¸Ğ· Ğ»Ğ¾ĞºĞ°Ğ»ÑŒĞ½Ğ¾Ğ¹ Ğ¿Ğ°Ğ¿ĞºĞ¸ caddy/
    - name: Copy docker-compose.yml
      copy:
        src: "{{ base_dir }}/caddy/docker-compose.yml"
        dest: "{{ working_dir }}/docker-compose.yml"
        mode: "0644"

    # 6) Ğ—Ğ°Ğ¿ÑƒÑĞº ĞºĞ¾Ğ½Ñ‚ĞµĞ¹Ğ½ĞµÑ€Ğ° Ñ‡ĞµÑ€ĞµĞ· Docker Compose\

    - name: Ğ—Ğ°Ğ¿ÑƒÑÑ‚Ğ¸Ñ‚ÑŒ ĞºĞ¾Ğ½Ñ‚ĞµĞ¹Ğ½ĞµÑ€ remnanode Ñ‡ĞµÑ€ĞµĞ· Docker Compose
      shell: |
        docker compose down
      args:
        chdir: "{{ working_dir }}"

    # âš ï¸ ĞÑ‡Ğ¸ÑÑ‚ĞºĞ° ĞºĞ°Ñ‚Ğ°Ğ»Ğ¾Ğ³Ğ° Ñ Ğ´Ğ°Ğ½Ğ½Ñ‹Ğ¼Ğ¸ Caddy
    - name: Stop existing Caddy containers (if any)
      shell: docker compose down
      args:
        chdir: "{{ working_dir }}"
      ignore_errors: yes

    - name: Clean old Caddy data (certificates, cache, etc.)
      file:
        path: "{{ working_dir }}/data"
        state: absent

    - name: Recreate empty Caddy data directory
      file:
        path: "{{ working_dir }}/data"
        state: directory
        mode: "0755"

    - name: Ğ—Ğ°Ğ¿ÑƒÑÑ‚Ğ¸Ñ‚ÑŒ ĞºĞ¾Ğ½Ñ‚ĞµĞ¹Ğ½ĞµÑ€ remnanode Ñ‡ĞµÑ€ĞµĞ· Docker Compose
      shell: |
        docker compose up -d
      args:
        chdir: "{{ working_dir }}"

    # â†’ ĞŸĞ¾Ğ»ÑƒÑ‡Ğ°ĞµĞ¼ Ğ¸Ğ¼Ñ ĞºĞ¾Ğ½Ñ‚ĞµĞ¹Ğ½ĞµÑ€Ğ° Caddy
    - name: Fetch Caddy container name
      command: >
        docker ps --format "{{'{{.Names}}'}}"
        --filter "name=caddy"
        --filter "status=running"
      register: caddy_container_search
      changed_when: false

    - name: Fail if no running Caddy container found
      fail:
        msg: "No running Caddy container found. Check docker-compose and container status."
      when: caddy_container_search.stdout_lines | length == 0

    - name: Set Caddy container name
      set_fact:
        caddy_container_name: "{{ caddy_container_search.stdout_lines | first }}"

    - name: Extract and display obtained domains from logs
      set_fact:
        obtained_domains: >-
          {{
            caddy_logs.stdout |
            regex_findall('certificate obtained for ([^\\s,]+)') |
            map('trim') | list | unique
          }}
      when: caddy_logs.stdout is defined

    # 7) ĞŸÑ€Ğ¾Ğ²ĞµÑ€ĞºĞ° Ñ€Ğ°Ğ±Ğ¾Ñ‚Ñ‹ ÑĞ°Ğ¹Ñ‚Ğ¾Ğ²
    - name: Wait for Caddy to start
      wait_for:
        port: 80
        host: 127.0.0.1
        delay: 2
        timeout: 30

    - name: Check HTTP to HTTPS redirect for domain.com
      uri:
        url: "http://localhost/"
        method: GET
        headers:
          Host: "{{ vault_target_domain_1 | default('CHANGE_ME') }}"
        status_code: 301
        follow_redirects: no
      register: redirect_check_mos

    - name: Check HTTP to HTTPS redirect for domain.com
      uri:
        url: "http://localhost/"
        method: GET
        headers:
          Host: "{{ vault_target_domain_2 | default('CHANGE_ME') }}"
        status_code: 301
        follow_redirects: no
      register: redirect_check_rebar

    # ĞŸÑ€Ğ¾Ğ²ĞµÑ€ÑĞµĞ¼, ÑƒÑÑ‚Ğ°Ğ½Ğ¾Ğ²Ğ»ĞµĞ½ Ğ»Ğ¸ tree
    - name: Check if 'tree' command is available
      command: which tree
      register: tree_check
      ignore_errors: yes
      changed_when: false

    # Ğ£ÑÑ‚Ğ°Ğ½Ğ°Ğ²Ğ»Ğ¸Ğ²Ğ°ĞµĞ¼ tree, ĞµÑĞ»Ğ¸ Ğ½Ğµ Ğ½Ğ°Ğ¹Ğ´ĞµĞ½ (Debian/Ubuntu)
    - name: Install tree package (Debian/Ubuntu)
      apt:
        name: tree
        state: present
        update_cache: yes
      when: tree_check.rc != 0 and ansible_os_family == "Debian"

    # Ğ£ÑÑ‚Ğ°Ğ½Ğ°Ğ²Ğ»Ğ¸Ğ²Ğ°ĞµĞ¼ tree, ĞµÑĞ»Ğ¸ Ğ½Ğµ Ğ½Ğ°Ğ¹Ğ´ĞµĞ½ (RHEL/CentOS/Fedora)
    - name: Install tree package (RHEL/CentOS/Fedora)
      yum:
        name: tree
        state: present
      when: tree_check.rc != 0 and ansible_os_family == "RedHat"

    - name: Install tree package (AlmaLinux/Rocky Linux)
      dnf:
        name: tree
        state: present
      when: tree_check.rc != 0 and ansible_os_family == "RedHat" and ansible_distribution in ["AlmaLinux", "Rocky"]

    # Ğ’Ñ‹Ğ¿Ğ¾Ğ»Ğ½ÑĞµĞ¼ Ğ¸ Ğ²Ñ‹Ğ²Ğ¾Ğ´Ğ¸Ğ¼ tree
    - name: Show directory structure with tree
      command: tree "{{ working_dir }}"
      register: tree_output
      changed_when: false

    - name: Display tree output
      debug:
        msg: |
          ğŸŒ² Directory Structure:
          {{ tree_output.stdout }}

    # â†’ ĞŸĞ¾Ğ»ÑƒÑ‡Ğ°ĞµĞ¼ Ğ¿Ğ¾ÑĞ»ĞµĞ´Ğ½Ğ¸Ğµ 50 ÑÑ‚Ñ€Ğ¾Ğº Ğ»Ğ¾Ğ³Ğ¾Ğ² Caddy Ğ´Ğ»Ñ Ğ¾Ñ‚Ğ»Ğ°Ğ´ĞºĞ¸
    - name: Fetch last 50 lines of Caddy container logs
      command: docker logs --tail 50 "{{ caddy_container_name }}"
      register: caddy_logs
      changed_when: false

    - name: Display last 50 lines of Caddy logs
      debug:
        msg: |
          ğŸ“œ LAST 50 LINES OF CADDY LOGS:
          {{ caddy_logs.stdout }}

    # 8) Wait for certificate files to appear (up to 5 minutes)
    - name: Wait for certificate files for domain.com
      wait_for:
        path: "{{ working_dir }}/data/caddy/certificates/acme-v02.api.letsencrypt.org-directory/domain.com/domain.com.crt"
        timeout: 300
      register: cert_wait_mos_crt

    - name: Wait for key file for domain.com
      wait_for:
        path: "{{ working_dir }}/data/caddy/certificates/acme-v02.api.letsencrypt.org-directory/domain.com/domain.com.key"
        timeout: 300
      register: cert_wait_mos_key

    - name: Wait for JSON metadata for domain.com
      wait_for:
        path: "{{ working_dir }}/data/caddy/certificates/acme-v02.api.letsencrypt.org-directory/domain.com/domain.com.json"
        timeout: 300
      register: cert_wait_mos_json

    - name: Wait for certificate files for domain.com
      wait_for:
        path: "{{ working_dir }}/data/caddy/certificates/acme-v02.api.letsencrypt.org-directory/domain.com/domain.com.crt"
        timeout: 300
      register: cert_wait_rebar_crt

    - name: Wait for key file for domain.com
      wait_for:
        path: "{{ working_dir }}/data/caddy/certificates/acme-v02.api.letsencrypt.org-directory/domain.com/domain.com.key"
        timeout: 300
      register: cert_wait_rebar_key

    - name: Wait for JSON metadata for domain.com
      wait_for:
        path: "{{ working_dir }}/data/caddy/certificates/acme-v02.api.letsencrypt.org-directory/domain.com/domain.com.json"
        timeout: 300
      register: cert_wait_rebar_json

    # 9) Read certificate metadata JSON files
    - name: Read domain.com certificate metadata
      slurp:
        src: "{{ working_dir }}/data/caddy/certificates/acme-v02.api.letsencrypt.org-directory/domain.com/domain.com.json"
      register: mos_json_raw
      when: cert_wait_mos_json is succeeded

    - name: Parse domain.com JSON
      set_fact:
        mos_cert_data: "{{ mos_json_raw.content | b64decode | from_json }}"
      when: mos_json_raw is defined and mos_json_raw.content is defined

    - name: Read domain.com certificate metadata
      slurp:
        src: "{{ working_dir }}/data/caddy/certificates/acme-v02.api.letsencrypt.org-directory/domain.com/domain.com.json"
      register: rebar_json_raw
      when: cert_wait_rebar_json is succeeded

    - name: Parse domain.com JSON
      set_fact:
        rebar_cert_data: "{{ rebar_json_raw.content | b64decode | from_json }}"
      when: rebar_json_raw is defined and rebar_json_raw.content is defined

    # 10) Set facts for certificate obtained status
    - name: Set certificate obtained flags
      set_fact:
        mos_cert_obtained: "{{ mos_cert_data is defined and 'sans' in mos_cert_data and 'domain.com' in mos_cert_data.sans }}"
        rebar_cert_obtained: "{{ rebar_cert_data is defined and 'sans' in rebar_cert_data and 'domain.com' in rebar_cert_data.sans }}"

    # 11) Fail if certificates not obtained
    - name: Fail if domain.com certificate not obtained
      fail:
        msg: "Certificate for domain.com was not obtained within 5 minutes."
      when: not mos_cert_obtained

    - name: Fail if domain.com certificate not obtained
      fail:
        msg: "Certificate for domain.com was not obtained within 5 minutes."
      when: not rebar_cert_obtained

    # 12) Ğ’Ñ‹Ğ²Ğ¾Ğ´ Ñ€ĞµĞ·ÑƒĞ»ÑŒÑ‚Ğ°Ñ‚Ğ¾Ğ²
    - name: Show deployment and SSL results
      debug:
        msg:
          - "âœ… remnanode container running"
          - "âœ… Caddy started and obtained certificate for domain.com => {{ mos_cert_obtained }}"
          - "âœ… Caddy started and obtained certificate for domain.com  => {{ rebar_cert_obtained }}"
          - "ğŸ” domain.com redirect => {{ redirect_check_mos.status | default('n/a') }}"
          - "ğŸ” domain.com redirect => {{ redirect_check_rebar.status | default('n/a') }}"
          - "ğŸŒ domain.com HTTPS => {{ site_check_mos.status | default('n/a') }}"
          - "ğŸŒ domain.com HTTPS => {{ site_check_rebar.status | default('n/a') }}"
          - "--- Certificate Issuer Info (domain.com) ---"
          - "Issuer URL => {{ mos_cert_data.issuer_data.url | default('N/A') }}"
          - "Renewal Window => {{ mos_cert_data.issuer_data.renewal_info.suggestedWindow.start | default('N/A') }} to {{ mos_cert_data.issuer_data.renewal_info.suggestedWindow.end | default('N/A') }}"
          - "--- Certificate Issuer Info (domain.com) ---"
          - "Issuer URL => {{ rebar_cert_data.issuer_data.url | default('N/A') }}"
          - "Renewal Window => {{ rebar_cert_data.issuer_data.renewal_info.suggestedWindow.start | default('N/A') }} to {{ rebar_cert_data.issuer_data.renewal_info.suggestedWindow.end | default('N/A') }}"
